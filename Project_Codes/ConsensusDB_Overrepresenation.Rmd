---
title: "Sorting POI on Go-terms PPI"
output: html_notebook
params:  
  Go-Term:
    label: "Go-Terms:"
    value: Go_terms.xlsx
    input: file
  data: 
    label: "Input dataset:"
    value: results.xlsx
    input: file
---
```{r library_loading, include=FALSE}
##pacman is like a package for package management

install.packages("pacman")
library('pacman')

### installing other packages
pacman::p_load_gh("krlmlr/here")
pacman::p_load("readr","tidyverse", "openxlsx", "stringr", "ontologyIndex", "biomaRt", 'here',"data.table","BiocManager")

#needed for readGAF, and GoAnnotations, installable through BiocManager
BiocManagerlibraries <- c("mgsa","GO.db","biomaRt","clusterProfiler","pathview","wordcloud")

for (i in BiocManagerlibraries){
if (!requireNamespace(i, quietly = TRUE))
    BiocManager::install(i)
    library(i)
}


####_______ loading library human for ClusterProfiler________####
organism = "org.Hs.eg.db"
#BiocManager::install(organism, character.only = TRUE)
library(organism, character.only = TRUE)
####_______ loading library human for ClusterProfiler________####

#sets wd in current location
file_location <- here()
setwd(file_location)
```

```{r file loading and pre-processing, include=FALSE}
GO_annotations <- read.xlsx("./../Project_Datasets/GO_annotations.xlsx")

#loads all the consensusDB, keeps high confidence and NA and limits complexes to size 5
#this ensures that a protein isn't getting a lot of GO terms from a single complex
ConsensusDB_PPI <- read_tsv("./../Project_Datasets/ConsensusPathDB_human_PPI") %>% 
  filter(interaction_confidence>0.5 | is.na(interaction_confidence)) %>%
  filter(str_count(.$interaction_participants,",")<6)

#list of all interactors
ConsensusDB_PPIs <- sapply(ConsensusDB_PPI$interaction_participants, function(x) str_split(x, pattern = ","))
Human_Proteins <- read_tsv("./../Project_Datasets/HUMAN_9606_idmapping.dat", col_names = FALSE) %>% 
  setNames(c("Uniprot", "Type", "Value"))
```

```{r Converting Input}
#### ______________ Input_file_name_____############
Go_terms_OI_test <- read.xlsx(params$Go-Term, colNames = F)$X1
POI_list_test <- read.xlsx(params$Go-Term, colNames = F)$X1


POI_list <- read.xlsx("./../Project_Datasets/POIS.xlsx", colNames = F)$X1
Go_terms_OI <- read.xlsx("./../Project_Datasets/Go_terms_OI_Laura1.xlsx", colNames = F)$X1

Uniprot_Conversion <- function(x){
  All_uniprots <- table(Human_Proteins$Uniprot[Human_Proteins$Value == x]) 
  names(which(All_uniprots == max(All_uniprots, na.rm = T)))
  
}

Converted <- sapply(POI_list, try(Uniprot_Conversion))
Converted <- data.frame(Name_provided = names(Converted), 
                             Uniprot = as.character(Converted),
                             stringsAsFactors = F)

Converted <- left_join(Converted,filter(Human_Proteins, 
                                        Human_Proteins$Uniprot %in% Converted$Uniprot &
                                        Human_Proteins$Type == "UniProtKB-ID"), 
                       by = "Uniprot") %>% drop_na()


```



```{r Getting Go terms and producing Output}


mart <- useMart(biomart = "ensembl", dataset = "hsapiens_gene_ensembl", "useast")

### finding the number of hits for all Go-terms of interest together for each protein in the list
POI_Go_detection <- function(x){
  print(x)
  results <- getBM(attributes = "go_id", filters = "uniprotswissprot",
           values = x, mart = mart)
  mean(str_count(results$go_id, paste(Go_terms_OI,collapse = "|")), na.rm = T)

}

j <- 1
while(j <= nrow(Converted)){
    for(i in j:nrow(Converted)){
      print(i)
  try(Converted$GO_POI[i] <- POI_Go_detection(Converted$Uniprot[i]))->doStuffResults
  }
    if(class(doStuffResults) != "try-error") i <- i + 1
}
write.xlsx(Converted,"test.xlsx")

if(nrow(Converted)>500){
  Converted <- Converted[with(Converted,order(GO_POI,decreasing = T)),]%>%
    .[1:500,]
}

### finding secondary interaction partners and their matching Goterms
PP_Go_detection <- function(x){
  print(x)
  PPI1s <- str_subset(ConsensusDB_PPI$interaction_participants, pattern = x) %>%
    str_split(pattern = ",")  %>% unlist() %>% unique() %>% .[. != x]
  
  Uniprots_PPI1 <- Human_Proteins$Uniprot[Human_Proteins$Value %in% PPI1s]
  
  PPI2s <- str_subset(ConsensusDB_PPI$interaction_participants, pattern = paste(PPI1s,collapse="|")) %>%
    str_split(pattern = ",")  %>% unlist() %>% unique() %>% .[!(. %in% PPI1s)]
  
  Uniprots_PPI2 <- Human_Proteins$Uniprot[Human_Proteins$Value %in% PPI2s]
  
  results_1 <- getBM(attributes = "go_id", filters = "uniprotswissprot",
           values = Uniprots_PPI1, mart = mart)
  
  results_2 <- getBM(attributes = "go_id", filters = "uniprotswissprot",
           values = Uniprots_PPI2, mart = mart)
  
  data.table(Value = x, PPI1 = list(PPI1s),
             Go_count_PPI1 = mean(str_count(results_1$go_id, paste(Go_terms_OI,collapse = "|")), na.rm=T),
             PPI2 = list(PPI2s), 
             Go_count_PPI2 = mean(str_count(results_2$go_id, paste(Go_terms_OI,collapse = "|")), na.rm =T))
}



#empty df for the output
PP_detected <- data.table(Value = character(nrow(Converted)), 
                          PPI1 = list(nrow(Converted)), 
                          Go_count_PPI1 = numeric(nrow(Converted)),
                          PPI2 = list(nrow(Converted)), 
                          Go_count_PPI2 = numeric(nrow(Converted)))

### find the number of partners and their Go-terms, and the number of match
count <- 1
for (i in Converted$Value[(count):nrow(Converted)]){
  n <- 0
  while(n<5){
   print(count)
   df <- try(PP_Go_detection(i), silent=TRUE)
   PP_detected[count] <- df
  if(!is(df, 'try-error')){
    count <- count+1
    break
  }
   else{
     print(df)
     n <- n+1
   }
  }
}


Converted <- left_join(Converted,PP_detected, by = "Value")
Converted <- left_join(Converted,Human_Proteins[Human_Proteins$Type == "GeneID",c(1,3)],  by = 'Uniprot')

for (i in 1:nrow(Converted)){
  Uniprots <- Human_Proteins$Uniprot[Human_Proteins$Value %in% Converted$PPI1[[i]]] 
  Converted$PPI1_gene_ids[i] <- list(Human_Proteins$Value[Human_Proteins$Uniprot %in% Uniprots & Human_Proteins$Type == "GeneID"])
}

Converted <- 
  getBM(attributes=c('uniprotswissprot','description'), filters = 'uniprotswissprot',
        values = Converted$Uniprot, mart =mart) %>%
  left_join(Converted,by =c("uniprotswissprot" = "Uniprot"))

Converted <- Converted[with(Converted,order(GO_POI,Go_count_PPI1,Go_count_PPI2, decreasing = T)),]
                            
for (i in 1:10){
  if (length(unlist(Converted$PPI1_gene_ids[i]))<10){
    print("smaller than 10")
  }
  else{
    write.xlsx(clusterProfiler::enrichGO(gene= unlist(Converted$PPI1_gene_ids[i]),OrgDb='org.Hs.eg.db',qvalueCutoff = 0.05)@result,
    paste0("./Project_Output/PPI1_",Converted$Name_provided[i],".xlsx"))
  }
}

write.xlsx(Converted[,-c(4,11:13)],"./Project_Output/POIs_Laura_sorted.xlsx")


```
